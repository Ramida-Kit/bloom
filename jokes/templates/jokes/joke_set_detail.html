{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ joke_set.name }}</h2>
    <a href="{% url 'joke_sets' %}" class="btn btn-outline-secondary">← Back to Joke Sets</a>
</div>

<div class="row">
    <!-- Left Column: Current Joke Set -->
    <div class="col-md-6">
        <h4>Current Joke Set</h4>
        <div id="joke-set-list" class="list-group">
            {% for item in joke_set_items %}
            <div class="list-group-item" data-item-id="{{ item.id }}" draggable="true">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="drag-handle me-2" style="cursor: move; color: #6c757d;">⋮⋮</span>
                        <strong>{{ item.joke.name }}</strong>
                        <small class="text-muted">({{ item.joke.category.name }})</small>
                        <p class="mb-1">{{ item.joke.setup }}</p>
                        <p class="mb-2"><em>{{ item.joke.punchline }}</em></p>
                        
                        <!-- Selected Toppers -->
                        <div class="selected-toppers" data-item-id="{{ item.id }}">
                            <strong>Toppers:</strong>
                            <ul class="list-group list-group-flush mt-1" id="topper-list-{{ item.id }}">
                                {% for joke_set_topper in item.selected_toppers.all %}
                                <li class="list-group-item py-1 d-flex align-items-center" data-topper-set-id="{{ joke_set_topper.id }}" draggable="true">
                                    <span class="drag-handle me-2" style="cursor: move; color: #6c757d; font-size: 0.8em;">⋮⋮</span>
                                    <span class="flex-grow-1">{{ joke_set_topper.topper.text }}</span>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove_topper">
                                        <input type="hidden" name="topper_id" value="{{ joke_set_topper.id }}">
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">×</button>
                                    </form>
                                </li>
                                {% empty %}
                                <li class="list-group-item py-1 text-muted">No toppers selected</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <form method="post" class="ms-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove_joke">
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                </div>
            </div>
            {% empty %}
            <div class="list-group-item text-muted text-center">
                No jokes in this set yet. Add jokes from the right panel.
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Column: Available Jokes -->
    <div class="col-md-6">
        <h4>Available Jokes</h4>
        <div class="accordion" id="categoryAccordion">
            {% for category in categories %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ category.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ category.id }}" aria-expanded="false">
                        {{ category.name }} ({{ category.jokes.count }} jokes)
                    </button>
                </h2>
                <div id="collapse{{ category.id }}" class="accordion-collapse collapse" data-bs-parent="#categoryAccordion">
                    <div class="accordion-body">
                        {% for joke in category.jokes.all %}
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong>{{ joke.name }}</strong>
                                        <p class="mb-1 small">{{ joke.setup }}</p>
                                        <p class="mb-2 small"><em>{{ joke.punchline }}</em></p>
                                        
                                        <!-- Available Toppers -->
                                        {% if joke.toppers.exists %}
                                        <div class="mt-2">
                                            <small><strong>Available Toppers:</strong></small>
                                            {% for topper in joke.toppers.all %}
                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                <small class="text-muted">{{ topper.text|truncatechars:50 }}</small>
                                                <form method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="add_topper">
                                                    <input type="hidden" name="item_id" id="item-for-topper-{{ topper.id }}">
                                                    <input type="hidden" name="topper_id" value="{{ topper.id }}">
                                                    <button type="button" class="btn btn-xs btn-outline-success add-topper-btn" data-topper-id="{{ topper.id }}">Add</button>
                                                </form>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <form method="post" class="ms-2">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="add_joke">
                                        <input type="hidden" name="joke_id" value="{{ joke.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-primary">Add to Set</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">No jokes in this category.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal for selecting joke for topper -->
<div class="modal fade" id="selectJokeModal" tabindex="-1" aria-labelledby="selectJokeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectJokeModalLabel">Select Joke for Topper</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select which joke in your set to add this topper to:</p>
                <div id="joke-selection-list">
                    {% for item in joke_set_items %}
                    <button type="button" class="btn btn-outline-primary mb-2 d-block w-100 select-joke-btn" data-item-id="{{ item.id }}">
                        {{ item.joke.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Drag and drop for jokes
let draggedJoke = null;
document.getElementById('joke-set-list').addEventListener('dragstart', function(e) {
    if (e.target.closest('[data-item-id]')) {
        draggedJoke = e.target.closest('[data-item-id]');
        draggedJoke.style.opacity = '0.5';
    }
});

document.getElementById('joke-set-list').addEventListener('dragover', function(e) {
    e.preventDefault();
    if (draggedJoke) {
        const afterElement = getDragAfterElement(this, e.clientY);
        if (afterElement == null) {
            this.appendChild(draggedJoke);
        } else {
            this.insertBefore(draggedJoke, afterElement);
        }
    }
});

document.getElementById('joke-set-list').addEventListener('dragend', function(e) {
    if (draggedJoke) {
        draggedJoke.style.opacity = '';
        updateJokeOrder();
        draggedJoke = null;
    }
});

// Drag and drop for toppers within each joke
document.querySelectorAll('[id^="topper-list-"]').forEach(function(list) {
    let draggedTopper = null;
    
    list.addEventListener('dragstart', function(e) {
        if (e.target.closest('[data-topper-set-id]')) {
            draggedTopper = e.target.closest('[data-topper-set-id]');
            draggedTopper.style.opacity = '0.5';
            e.stopPropagation();
        }
    });
    
    list.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (draggedTopper) {
            const afterElement = getDragAfterElement(this, e.clientY);
            if (afterElement == null) {
                this.appendChild(draggedTopper);
            } else {
                this.insertBefore(draggedTopper, afterElement);
            }
        }
    });
    
    list.addEventListener('dragend', function(e) {
        if (draggedTopper) {
            draggedTopper.style.opacity = '';
            updateTopperOrder(list.id.split('-').pop());
            draggedTopper = null;
        }
        e.stopPropagation();
    });
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('[draggable="true"]:not([style*="opacity: 0.5"])')]
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect()
        const offset = y - box.top - box.height / 2
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child }
        } else {
            return closest
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element
}

function updateJokeOrder() {
    const items = document.querySelectorAll('#joke-set-list [data-item-id]');
    const orders = Array.from(items).map(item => item.dataset.itemId);
    
    // Send AJAX request to update order
    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=update_order&joke_orders=${orders.join(',')}`
    });
}

function updateTopperOrder(itemId) {
    const toppers = document.querySelectorAll(`#topper-list-${itemId} [data-topper-set-id]`);
    const orders = Array.from(toppers).map(topper => topper.dataset.topperSetId);
    
    // Send AJAX request to update topper order
    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=update_order&topper_orders=${orders.join(',')}&item_id_for_toppers=${itemId}`
    });
}

// Handle topper selection
let selectedTopperId = null;
document.querySelectorAll('.add-topper-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        selectedTopperId = this.dataset.topperId;
        const modal = new bootstrap.Modal(document.getElementById('selectJokeModal'));
        modal.show();
    });
});

document.querySelectorAll('.select-joke-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const itemId = this.dataset.itemId;
        document.getElementById(`item-for-topper-${selectedTopperId}`).value = itemId;
        
        // Submit the form
        const form = document.querySelector(`input[value="${selectedTopperId}"]`).closest('form');
        form.submit();
    });
});

// CSS for better drag and drop experience
const style = document.createElement('style');
style.textContent = `
    .drag-handle { user-select: none; }
    [draggable="true"]:hover { background-color: #f8f9fa; }
    .btn-xs { padding: 0.1rem 0.3rem; font-size: 0.75rem; }
`;
document.head.appendChild(style);
</script>
{% endblock %}
